---
title: "💬멀티 스레딩의 성능에 대하여"
date: 2025-01-16 16:45 +0900
categories: [CS]
tags: [multi threading, thread, thread pool]
---

> [저번 글](https://euihyunee.github.io/posts/multi_process_thread/)에서 멀티 프로세스와 멀티 스레드에 대해 알아보았습니다. 이번 글에서는 멀티 스레딩의 성능에 대해 살펴보겠습니다. 멀티 스레드와 멀티 스레딩은 이름처럼 같은 개념이지만 약간의 차이가 있습니다. 멀티 스레딩은 하나의 프로세스 내에서 여러 개의 스레드를 동시에 실행하는 프로그래밍 기법을 의미합니다. 멀티 스레딩의 결과로 생성된 여러 개의 스레드가 멀티 스레드입니다. 그럼 멀티 스레딩에 대해서 알아보겠습니다. 

## 멀티 스레딩와 멀티 스레드의 차이점?

> - 멀티 스레드: 하나의 프로세스 내에서 둘 이상의 스레드가 동시에 실행되는 것을 의미
> - 멀티 스레딩: 멀티 스레드를 사용하여 프로그램을 구현하는 프로그래밍 기법이며 멀티 스레드 프로그래밍이라고도 합니다.

위의 정의를 풀어쓰면 멀티 스레딩은 하나의 프로세스 내에서 둘 이상의 스레드가 동시에 작업을 수행하는 프로그래밍 기법입니다. 멀티 스레딩을 통해 멀티 스레드의 성능을 향상 시키고 자원을 효율적으로 사용할 수 있습니다. 이처럼 멀티 스레딩은 프로그래밍에서 강력한 도구이지만, 장점과 단점을 모두 가지고 있습니다. 

멀티 스레딩의 주요 장점은 다음과 같습니다. 

📋먼저, 응답성 향상이 있습니다. 멀티 스레딩을 사용하면 프로그램의 일부분(스레드)이 중단되거나 긴 작업을 수행하더라고 프로그램의 수행이 계속되어 사용자에 대한 응답성이 증가합니다. 예를 들어, 웹 브라우저에서 하나의 스레드가 이미지 파일을 로드하는 동안 다른 스레드에서 사용자는 다른 작업을 하며 상호작용이 가능합니다.

📋두 번째로, 자원을 효율적으로 사용 가능합니다. 프로세스 내 자원들과 메모리를 공유하기 때문에 메모리 공간과 시스템 자원 소모가 줄어듭니다. 스레드 간 통신이 필요한 경우에도 쉽게 데이터를 주고받을 수 있으며, 프로세스의 컨텍스트 스위칭과 달리 스레드 간의 컨텍스트 스위칭은 캐시 메모리를 비울 필요가 없기 때문에 더 빠르다는 장점이 있습니다.

📋세 번째로, 병렬 수행이 있습니다. 멀티 스레딩을 통한 병렬 수행은 전체적인 프로그램 성능을 크게 향상시킬 수 있습니다.여러 CPU 코어를 동시에 활용하여 작업을 병렬로 처리함으로써 전체 실행 시간을 단축할 수 있습니다. 특히 다중 CPU 시스템에서는 각 스레드를 다른 프로세서에서 병렬로 실행하여 병렬성을 극대화할 수 있습니다.

이처럼 멀티 스레딩은 스레드의 유형과 수, 작업 부하의 특성, 시스템 구성에 따라 CPU 성능과 효율성을 증가시킬 수 있습니다. 하지만 반대로 멀티 스레딩에는 다음과 같은 고려해야 할 단점들이 있습니다.

📋먼저, 대표적인 동기화 문제가 있습니다. 이는 여러 스레드가 공유 자원에 동시에 접근하여 경쟁 상태가 발생하여, 실행 결과가 달라질 수 있는 문제입니다. 이를 해결하기 위해 뮤텍스나 세마포어와 같은 동기화 메커니즘을 사용할 수 있지만, 이로 인해 성능 저하가 발생할 수 있습니다. 과도한 동기화는 병목 현상을 일으켜 전체 프로그램의 성능을 향상시킬 수 있습니다.

📋두 번째로, 데드락이 발생할 위험이 있습니다. 데드락은 자원을 기다리지만 더 이상 진행할 수 없는 상황입니다. 즉, 여러 스레드가 서로 다른 리소스를 점유한 채 상대방의 리소스를 기다리는 상황이 발생할 수 있으며, 이는 프로그램의 실행을 완전히 멈추게 할 수 있습니다.

📋세 번째로, 리소스의 사용이 증가합니다. 스레드를 생성하고 관리하는 데에 시스템 리소스가 필요하기에 스레드 수가 많아질 수록 메모리 사용량도 함께 증가합니다. 또한 스레드를 전환하기 위해 컨텍스트 스위칭을 하는 것도 스레드 수에 비용이 비례합니다. 이러한 요인 때문에 CPU 시간이 소비되어 전체적인 시스템 효율성이 감소할 수 있습니다.

📋네 번째로, 안정성 문제가 있습니다. 한 프로세스 내에서 스레드들이 공유 자원에 동시 접근할 수 있는 것은 메모리적으로 분명한 장점이 있지만, 하나의 스레드에서 발생한 예외나 오류가 다른 스레드로 전파되어 다른 스레드들이 영향을 받아 전체 프로그램이 종료될 수 있는 단점이 있습니다.

멀티 스레딩은 여러 가지 방법으로 CPU의 성능과 효율성을 개선할 수 있지만, 이러한 장단점을 고려하여 적절히 사용해야 합니다. 특히 동기화, 데드락 방지, 리소스 관리 등에 주의를 기울여야 하며, 프로그램의 요구사항과 특성에 따라 멀티 스레딩의 적용 여부를 신중히 결정해야 합니다.


## 멀티 스레딩의 주의점 

따라서 멀티 스레딩을 도입하기 위해서는 주의가 필요하다. 이 단락에서는 주의점에 대해 정리해보겠습니다.

### 동기화 문제

1. 경쟁 상태(Race Condition) 방지  
여러 스레드가 공유 자원에 동시에 접근할 때 발생할 수 있는 데이터 불일치를 방지해야 합니다. 이를 위해 적절한 동기화 메커니즘을 사용해야 합니다. 
2. 데드락(Deadlock) 예방  
여러 스레드가 서로 상대방이 가진 자원을 기다리며 무한정 대기하는 상황을 피해야 합니다. 리소스 점유 순서를 일관되게 유지하고, 중첩된 리소스 점유를 피하는 것이 중요합니다.

### 성능 최적화

시스템 자원을 고려하여 최적의 스레드 수를 선택해야 합니다. 과도한 스레드 생성은 컨텍스트 스위칭 오버헤드를 증가시킬 수 있습니다. 

여기에 스레드 풀이라는 멀티 스레드 최적화를 사용하여 스레드를 미리 생성하여 생성과 소멸에 따른 오버헤드를 줄이는 방법이 있습니다. 

### 메모리 관리 

1. 공유 메모리 접근 제어  
여러 스레드가 동일한 메모리 영역에 접근할 때 발생할 수 있는 문제를 방지하기 위해 적절한 동기화 기법을 사용해야 합니다. 
2. 메모리 누수 방지  
특히 ThreadLocal 사용 시 스레드 풀 환경에서 메모리 누수가 발생할 수 있으므로 주의가 필요합니다.

### 설계 및 구현 

1. 복잡성 관리  
멀티 스레드 프로그램은 설계와 구현이 복잡해질 수 있으므로, 코드의 가독성과 유지보수성을 고려해야 합니다.
2. 예외 처리  
스레드 내에서 발생하는 예외를 적절히 처리하여 프로그램의 안정성을 유지해야 합니다.

### 테스트 및 디버깅

1. 재현 가능성 확보  
멀티 스레드 환경에서는 버그 재현이 어려울 수 있으므로, 체계적인 테스트 방법을 마련해야 합니다.
2. 적절한 로깅  
스레드 간 상호 작용을 추적할 수 있도록 적절한 로깅 전략을 수립해야 합니다.

> 멀티 스레딩을 도입할 때는 이러한 주의점들을 고려하여 신중하게 설계하고 구현해야 합니다. 또한 지속적인 성능 모니터링과 최적화를 통해 멀티 스레딩의 이점을 최대한 활용할 수 있도록 해야 합니다.

## 대표적인 멀티 스레드 성능 최적화 전략

멀티 스레딩을 최적화하는 가장 대표적인 방법은 스레드 풀(Thread Pool)을 사용하는 것입니다. 스레드 풀은 멀티 스레드의 성능을 크게 향상시킬 수 있는 효과적인 기법입니다. 

**스레드 풀**은 미리 생성된 여러 개의 스레드를 관리하는 자료구조입니다. 이 스레드들은 작업이 할당될 때까지 대기 상태로 유지되다가, 필요할 때 재사용됩니다. 

![thread_pool.png](https://github.com/Euihyunee/euihyunee.github.io/blob/main/_posts/img/thread_pool.png?raw=true)

1. 클라이언트(작업 생성자)가 작업을 생성하여 제출합니다.
2. 제출된 작업은 작업 큐에 저장됩니다.
3. 스레드 풀은 미리 생성된 여러 개의 스레드를 관리합니다.
4. 스레드 풀의 스레드들은 작업 큐에서 작업을 가져와 실행합니다.
5. 작업이 완료되면 스레드는 다시 풀로 돌아가 다음 작업을 기다립니다. 

스레드 풀은 이미 생성된 스레드를 재사용하기에 오버헤드가 감소하고, 응답성이 향상됩니다. 또한 동시에 실행되는 스레드 수를 제한할 수 있기 때문에 시스템 자원을 효율적으로 관리할 수 있습니다. 

이렇게 스레드 풀을 활용하면 동시에 들어오는 요청을 처리할 수 있습니다. 특히 웹 서버에서 아파치 톰캣 서버에서 내부적으로 스레드 풀을 사용하여 HTTP 요청을 처리합니다. 이는 동시에 많은 클라이언트 요청을 처리하며 서버의 응답성과 처리량을 향상시킬 수 있습니다. 

실제 웹 서버에서의 스레드 풀 활용  
```java 
ExecutorService executor = 
ExecutorService.newFixedThreadPool(10);
for(int i = 0; i < 100; i++){
    Runnable worker = new WorkerThread("" + i);
    executor.execute(worker);
}
executor.shutdown();
```

이 예제에서는 10개의 스레드로 구성된 고정 크기 스레드 풀을 생성하고, 100개의 작업을 제출합니다. 스레드 풀은 이 작업들을 10개의 스레드를 사용하여 효율적으로 처리합니다.

> 이외에도 데이터베이스 쿼리 요청, 모바일 앱, 메시지 브로커, 대규모 데이터 처리 등에서 사용합니다. 스레드 풀을 사용함으로써 개발자는 동시성 관리의 복잡성을 줄이고, 애플리케이션의 성능이나 확장성을 향상시킬 수 있습니다. 

스레드 풀은 스레드의 생성과 소멸에 따른 오버헤드를 줄이기 위한 멀티 스레드 최적화 전략입니다. CPU의 성능과 효율성을 최적화하기 위해 작업 크기, 복잡성, 종속성, 빈도, 우선 순위, 가변성, 작업 부하, 스레드의 수와 유형에서 스레드의 병렬성과 동시성을 극대화하고 오버헤드를 최소화하는 다양한 최적화 전략들이 있습니다. 또한 스레드의 성능과 효율성을 모니터링하고 조정할 수 있습니다. 

## 마치며 

이상으로 멀티 스레딩에 대해 알아보았습니다. 멀티 스레딩은 굉장히 복잡한 주제이므로 천천히 단계적으로 접근하는 것이 중요해 보입니다. 개념을 확실히 이해하고, 멀티 스레딩을 사용하는 언어의 라이브러리를 학습하는게 우선으로 보입니다. 이후 메커니즘과 패턴을 학습하며 간단한 실습을 통해 디버깅 기술을 익히며 성능을 확인해서 개선점을 찾을 수 있어야 제대로 된 멀티 스레드 최적화를 학습할 수 있을 것 같습니다. 